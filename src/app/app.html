<div class="lottery-container" [class.has-custom-bg]="hasCustomBackground()">
  
  <!-- Background Image (only show if uploaded) -->
  <div class="bg-image" *ngIf="hasCustomBackground()"></div>
  
  
  <header class="header">
    <div class="header-container">
      <!-- Title Section (Left) -->
      <div class="header-left">
        <h1 class="app-title">{{ appTitle() }}</h1>
        <p class="app-subtitle">{{ appSubtitle() }}</p>
      </div>
      
      <!-- Navigation Menu (Right) -->
      <div class="header-right">
        <nav class="nav-menu">
          <button type="button" (click)="showMainSection()" class="btn-nav" 
                  [class.active]="!showParticipants() && !showHistory() && !showConfig()">
            ğŸ¯ Undian Utama
          </button>
          <button type="button" (click)="showParticipantsSection()" class="btn-nav"
                  [class.active]="showParticipants()">
            ğŸ“‹ Kelola Peserta
          </button>
          <button type="button" (click)="showHistorySection()" class="btn-nav"
                  [class.active]="showHistory()">
            ğŸ† Lihat Riwayat
          </button>
          <button type="button" (click)="showConfigSection()" class="btn-nav"
                  [class.active]="showConfig()">
            âš™ï¸ Konfigurasi
          </button>
          <button type="button" (click)="toggleFullscreen()" class="btn-nav fullscreen-btn"
                  [class.active]="isFullscreen()">
            <span *ngIf="!isFullscreen()">ğŸ–¥ï¸</span>
            <span *ngIf="isFullscreen()">ğŸ”™</span>
          </button>
        </nav>
      </div>
    </div>
  </header>

  <main class="main-content">
    <!-- Main Lottery Section -->
    <section class="lottery-main-section" *ngIf="!showParticipants() && !showHistory() && !showConfig()">
    <!-- Lottery Settings -->
    <section class="lottery-settings-section">
      <div class="lottery-settings-controls">
        
        <!-- Participants Summary at top -->
        @if (participants().length > 0) {
          <div class="participants-summary">
            <div class="summary-stats">
              <div class="stat-item">
                <span class="stat-number">{{ participants().length }}</span>
                <span class="stat-label">Total Peserta</span>
              </div>
              @if (winners().length > 0) {
                <div class="stat-item">
                  <span class="stat-number">{{ winners().length }}</span>
                  <span class="stat-label">Sudah Menang</span>
                </div>
              }
              <div class="stat-item">
                <span class="stat-number">{{ availableParticipants.length }}</span>
                <span class="stat-label">Bisa Diundi</span>
              </div>
            </div>
          </div>
        }

        <!-- Winner Count Controls -->
        <div class="winner-count-controls">
          <label for="winner-count" class="winner-count-label">
            <span class="label-text">ğŸ¯ Jumlah Pemenang:</span>
            <div class="count-input-group">
              <button 
                type="button" 
                (click)="updateWinnerCount(winnerCount() - 1)"
                class="btn btn-count-adjust"
                [disabled]="winnerCount() <= 1 || isDrawing()"
              >
                âˆ’
              </button>
              <input 
                id="winner-count"
                type="number" 
                [(ngModel)]="winnerCount"
                min="1"
                [max]="availableParticipants.length || 1"
                class="winner-count-input"
                [disabled]="isDrawing()"
                (blur)="updateWinnerCount(winnerCount())"
              />
              <button 
                type="button" 
                (click)="updateWinnerCount(winnerCount() + 1)"
                class="btn btn-count-adjust"
                [disabled]="winnerCount() >= (availableParticipants.length || 1) || isDrawing()"
              >
                +
              </button>
            </div>
          </label>
          
          <!-- Draw Info integrated here -->
          @if (availableParticipants.length > 0) {
            <div class="draw-info-inline">
              <p class="draw-summary">
                Akan mengundi <strong>{{ Math.min(winnerCount(), availableParticipants.length) }}</strong> 
                pemenang dari <strong>{{ availableParticipants.length }}</strong> peserta tersedia
              </p>
            </div>
          } @else if (participants().length > 0) {
            <div class="winner-count-info">
              <span class="info-text warning">
                Semua peserta sudah menang! Reset untuk undian ulang.
              </span>
            </div>
          }
        </div>
      </div>
    </section>

    <!-- Draw Section -->
    <section class="draw-section">

      
      @if (participants().length === 0) {
        <div class="empty-state">
          <div class="empty-icon">ğŸ“</div>
          <h3>Belum Ada Peserta</h3>
          <p>Klik "ğŸ“‹ Kelola Peserta" untuk menambahkan peserta</p>
          <button 
            type="button" 
            (click)="showParticipantsSection()"
            class="btn btn-primary"
          >
            ğŸ“‹ Kelola Peserta
          </button>
        </div>
      } @else if (availableParticipants.length > 0) {

        
        <div class="draw-controls">
          <button 
            type="button" 
            (click)="drawWinner()"
            class="btn btn-draw"
            [disabled]="isDrawing()"
          >
            @if (isDrawing()) {
              <span class="spinner"></span>
              Sedang Mengundi...
            } @else {
              ğŸ° Mulai Undian {{ winnerCount() > 1 ? '(' + winnerCount() + ' Pemenang)' : '' }}
            }
          </button>

          @if (isDrawing()) {
            <button 
              type="button" 
              (click)="stopDrawing()"
              class="btn btn-stop"
            >
              ğŸ›‘ Hentikan Undian
            </button>
          }
          

        </div>
      } @else if (participants().length > 0) {
        <div class="no-available-participants">
          <p>ğŸ‰ Semua peserta sudah memenangkan undian!</p>
          <p>Silakan gunakan menu "ğŸ“‹ Kelola Peserta" untuk mengelola peserta dan pemenang.</p>
        </div>
      }
      
      <!-- Latest Winners Display -->
      @if (currentWinner() && isDrawing()) {
        <!-- Show current drawing animation -->
        <div class="winner-section drawing">
          <h3>Mengundi...</h3>
          <div class="winner-name">{{ currentWinner() }}</div>
        </div>
      }
      
      @if (latestWinners().length > 0 && !isDrawing()) {
        <!-- Show latest winners from the most recent draw -->
        <div class="winner-section">
          <h3>
            ğŸ‰ {{ latestWinners().length > 1 ? 'Pemenang Terbaru!' : 'Pemenang Terbaru!' }}
          </h3>
          <!-- Debug info (can be removed later) -->
          <!-- <small style="color: #999;">Debug: Winners={{ latestWinners().length }}, Drawing={{ isDrawing() }}</small> -->
          
          @if (latestWinners().length === 1) {
            <!-- Single winner display -->
            <div class="winner-name">{{ latestWinners()[0] }}</div>
            <div class="celebration">ğŸŠ Selamat! ğŸŠ</div>
          } @else {
            <!-- Multiple winners display -->
            <div class="multiple-winners">
              <div class="winners-count-badge">
                {{ latestWinners().length }} Pemenang
              </div>
              <div class="latest-winners-grid">
                @for (winner of latestWinners(); track winner; let i = $index) {
                  <div class="latest-winner-card">
                    <div class="winner-rank">#{{ i + 1 }}</div>
                    <div class="winner-name-latest">{{ winner }}</div>
                  </div>
                }
              </div>
              <div class="celebration">ğŸŠ Selamat Semua! ğŸŠ</div>
            </div>
          }
        </div>
      }
    </section>
    </section>

    <!-- Participants Management Section -->
    <section class="participants-section" *ngIf="showParticipants()">
      <div class="section-header">
        <h2>ğŸ“‹ Kelola Peserta</h2>
        <p class="section-subtitle">Tambah, edit, atau hapus peserta undian</p>
      </div>

      <!-- Add New Participant -->
      <div class="add-participant-card">
        <h3>â• Tambah Peserta Baru</h3>
        <div class="add-participant-form">
          <div class="input-group">
            <input 
              type="text" 
              [(ngModel)]="newParticipant" 
              placeholder="Masukkan nama peserta..."
              (keydown.enter)="addParticipant()"
              class="participant-input"
              maxlength="50"
            >
            <button 
              (click)="addParticipant()" 
              class="btn-add-participant"
              [disabled]="!newParticipant().trim()"
            >
              â• Tambah
            </button>
          </div>
        </div>
      </div>

      <!-- CSV Import/Export -->
      <div class="csv-operations-card">
        <h3>ğŸ“Š Import/Export CSV</h3>
        <div class="csv-operations">
          <div class="csv-import">
            <label class="csv-label">ğŸ“¥ Import dari Google Sheets CSV:</label>
            <div class="csv-input-group">
              <input 
                type="file" 
                accept=".csv"
                (change)="onCsvFileSelected($event)"
                class="csv-file-input"
                #csvFileInput
                id="csv-file-input"
              >
              <label for="csv-file-input" class="csv-upload-btn">
                ğŸ“ Pilih File CSV
              </label>
              <div class="csv-info" *ngIf="csvFileName()">
                <span class="csv-filename">ğŸ“„ {{ csvFileName() }}</span>
              </div>
            </div>
            <button 
              (click)="downloadSampleCSV()" 
              class="csv-sample-btn"
            >
              ğŸ“„ Download Sample CSV
            </button>
            <p class="csv-help">
              ğŸ’¡ Format CSV: kolom pertama berisi nama peserta. Baris pertama (header) akan diabaikan.
            </p>
          </div>

          <div class="csv-export">
            <label class="csv-label">ğŸ“¤ Export ke CSV:</label>
            <button 
              (click)="exportToCSV()" 
              class="csv-export-btn"
              [disabled]="participants().length === 0"
            >
              ğŸ’¾ Download CSV
            </button>
            <p class="csv-help">
              ğŸ’¡ Download daftar peserta dalam format CSV untuk Google Sheets
            </p>
          </div>
        </div>
      </div>

      <!-- Participants List -->
      <div class="participants-list-card">
        <div class="participants-header">
          <h3>ğŸ‘¥ Daftar Peserta ({{ participants().length }})</h3>
          <button 
            (click)="clearAllParticipants()" 
            class="btn-clear-all"
            [disabled]="participants().length === 0"
          >
            ğŸ—‘ï¸ Hapus Semua
          </button>
        </div>

        @if (participants().length === 0) {
          <div class="empty-participants">
            <p>Belum ada peserta terdaftar</p>
            <p class="empty-subtitle">Tambahkan peserta untuk memulai undian</p>
          </div>
        } @else {
          <div class="participants-grid">
            @for (participant of participants(); track participant; let i = $index) {
              <div class="participant-card">
                <div class="participant-info">
                  <span class="participant-number">{{ i + 1 }}</span>
                  <span class="participant-name">{{ participant }}</span>
                </div>
                <button 
                  (click)="removeParticipant(participant)" 
                  class="btn-remove-participant"
                  title="Hapus {{ participant }}"
                >
                  âŒ
                </button>
              </div>
            }
          </div>
        }
      </div>
    </section>

    <!-- History Section -->
    <section class="history-section" *ngIf="showHistory()">
      <div class="section-header">
        <h2>ğŸ† Riwayat Undian</h2>
        <p class="section-subtitle">Lihat hasil undian sebelumnya</p>
      </div>

      <!-- History Controls -->
      <div class="history-controls">
        <button 
          (click)="clearAllHistory()" 
          class="btn-clear-history"
          [disabled]="drawSessions().length === 0"
        >
          ğŸ—‘ï¸ Hapus Riwayat
        </button>
        <div class="history-stats">
          <span class="stat-item">ğŸ“Š {{ drawSessions().length }} Sesi Undian</span>
          <span class="stat-item">ğŸ† {{ winners().length }} Total Pemenang</span>
        </div>
      </div>

      <!-- History List -->
      @if (drawSessions().length === 0) {
        <div class="empty-history">
          <p>Belum ada riwayat undian</p>
          <p class="empty-subtitle">Lakukan undian untuk melihat riwayat</p>
        </div>
      } @else {
        <div class="history-list">
          @for (session of sortedDrawSessions; track session.sessionId) {
            <div class="history-card">
              <div class="history-header">
                <h4>ğŸ¯ Sesi #{{ session.sessionId }}</h4>
                <span class="history-date">{{ session.timestamp | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>
              <div class="history-winners">
                <span class="winners-label">ğŸ† Pemenang ({{ session.winners.length }}):</span>
                <div class="winners-list">
                  @for (winner of session.winners; track winner; let i = $index) {
                    <span class="winner-tag">{{ i + 1 }}. {{ winner }}</span>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      }
    </section>

    <!-- Configuration Section -->
    <section class="config-section" *ngIf="showConfig()">
      <div class="section-header">
        <h2>âš™ï¸ Konfigurasi</h2>
        <p class="section-subtitle">Atur tampilan dan pengaturan aplikasi undian</p>
      </div>

      <!-- Text Configuration Card -->
      <div class="text-config-card">
        <h3>ğŸ“ Pengaturan Teks</h3>
        <div class="text-config-container">
          <div class="text-config-group">
            <label class="text-label">ğŸ·ï¸ Judul Utama:</label>
            <div class="text-input-group">
              <input 
                type="text" 
                [(ngModel)]="appTitle"
                (blur)="updateAppTitle(appTitle())"
                class="text-config-input"
                placeholder="Contoh: Undian Berhadiah"
                maxlength="50"
              >
              <button 
                type="button" 
                (click)="appTitle.set('Undian Berhadiah'); updateAppTitle(appTitle())" 
                class="btn-reset-text"
                title="Reset ke default"
              >
                ğŸ”„
              </button>
            </div>
            <p class="text-help">ğŸ’¡ Judul yang ditampilkan di bagian atas aplikasi</p>
          </div>

          <div class="text-config-group">
            <label class="text-label">ğŸ“„ Sub Judul:</label>
            <div class="text-input-group">
              <input 
                type="text" 
                [(ngModel)]="appSubtitle"
                (blur)="updateAppSubtitle(appSubtitle())"
                class="text-config-input"
                placeholder="Contoh: Kelola peserta dan lakukan undian berhadiah!"
                maxlength="100"
              >
              <button 
                type="button" 
                (click)="appSubtitle.set('Kelola peserta dan lakukan undian berhadiah!'); updateAppSubtitle(appSubtitle())" 
                class="btn-reset-text"
                title="Reset ke default"
              >
                ğŸ”„
              </button>
            </div>
            <p class="text-help">ğŸ’¡ Deskripsi yang ditampilkan di bawah judul utama</p>
          </div>

          <div class="text-actions">
            <button 
              type="button" 
              (click)="resetToDefaultTexts()" 
              class="btn-reset-all-texts"
            >
              ğŸ”„ Reset Semua Teks
            </button>
          </div>
        </div>
      </div>

      <!-- Background Type Selection -->
      <div class="background-type-card">
        <h3>ğŸ–¼ï¸ Pilih Jenis Background</h3>
        <div class="background-options">
          <button 
            type="button" 
            (click)="setDefaultBackground()" 
            class="background-option-btn"
            [class.active]="!hasCustomBackground()"
          >
            <span class="option-icon">ğŸ¨</span>
            <span class="option-text">Default Gradient</span>
            <span class="option-desc">Background gradient bawaan</span>
          </button>
          <button 
            type="button" 
            (click)="showImageUpload()" 
            class="background-option-btn"
            [class.active]="hasCustomBackground()"
          >
            <span class="option-icon">ğŸ“</span>
            <span class="option-text">Upload Gambar</span>
            <span class="option-desc">Background gambar/GIF kustom</span>
          </button>
        </div>
      </div>

      <!-- Image Upload Card -->
      <div class="image-upload-card" *ngIf="showImageUploadCard()">
        <h3>ğŸ–¼ï¸ Upload Background Image</h3>
        <div class="image-upload-container">
          <div class="upload-area">
            <input 
              type="file" 
              accept=".gif,.jpg,.jpeg,.png,.webp,image/gif,image/jpeg,image/jpg,image/png,image/webp"
              (change)="onImageFileSelected($event)"
              class="image-file-input"
              #imageFileInput
              id="image-file-input"
            >
            <label for="image-file-input" class="image-upload-btn">
              ğŸ“ Pilih File Gambar
            </label>
            <p class="upload-help">
              ğŸ’¡ Pilih file gambar untuk dijadikan background (GIF, JPG, PNG, WebP)
            </p>
          </div>

          <div class="image-info-container" *ngIf="currentImageInfo()">
            <div class="image-info">
              <div class="image-details">
                <span class="image-filename">ğŸ“„ {{ currentImageInfo()?.name }}</span>
                <span class="image-size">ğŸ“ {{ formatFileSize(currentImageInfo()?.size || 0) }}</span>
                <span class="image-type">ğŸ·ï¸ {{ getImageTypeLabel(currentImageInfo()?.type || '') }}</span>
              </div>
              <button 
                type="button" 
                (click)="removeCustomBackground()" 
                class="remove-image-btn"
              >
                ğŸ—‘ï¸ Hapus Gambar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Current Background Status -->
      <div class="background-status-card">
        <h3>ğŸ“Š Status Background Saat Ini</h3>
        <div class="status-info">
          <div class="status-item">
            <span class="status-label">Jenis Background:</span>
            <span class="status-value" [class.image-active]="hasCustomBackground()" [class.default-active]="!hasCustomBackground()">
              {{ hasCustomBackground() ? 'ğŸ–¼ï¸ Custom Background' : 'ğŸ¨ Default Gradient' }}
            </span>
          </div>
          <div class="status-item" *ngIf="hasCustomBackground() && currentImageInfo()">
            <span class="status-label">File Gambar:</span>
            <span class="status-value">{{ currentImageInfo()?.name }}</span>
          </div>
          <div class="status-item" *ngIf="hasCustomBackground() && currentImageInfo()">
            <span class="status-label">Jenis File:</span>
            <span class="status-value">{{ getImageTypeLabel(currentImageInfo()?.type || '') }}</span>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

